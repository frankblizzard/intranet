%h1 Controlling
- intern = 0
- extern = 0
- absence = 0
- summe = 0
- todoo = 0
- saldoo = 0

.month
  = link_to "<", :date => (@date.beginning_of_month-1).strftime("%Y-%m-%d")
  =h @date.strftime("%B %Y")
  = link_to ">", :date => (@date.end_of_month+1).strftime("%Y-%m-%d")
  .controlling_month_select= date_select("month", "date", :start_year => Time.now.year-1, :end_year => Time.now.year+1, :discard_day => true, :default => @date)
  .dl_xls= link_to "Download xls", url_for(:format => 'xls', :date => @date)  


#scrolldiv
  %table.controlling
    %tr
      %th 
      %th{:colspan => 6}= @date.strftime('%B %Y')


    %tr
      %th 
      %th inhouse
      %th extern
      %th absence
      %th summe
      %th todo
      %th saldo (+/-)

    - @profiles.each do |p|
      - u = p.user
      %tr
        %td.border= link_to u.username, profile_path(u.profile) # need to link to the profile, not user
        - h = u.hours.no_absence.by_month(@date).eve_intern.to_a.sum { |hour| hour.amount }
        %td.border= h
        - intern += h
        - s1 = h
        - h = u.hours.no_absence.by_month(@date).extern.to_a.sum { |hour| hour.amount }
        %td.border= h
        - extern += h
        - s2 = h
        - h = u.hours.by_month(@date).absence.to_a.sum { |hour| hour.amount }
        %td.border= h
        - absence += h
        - s3 = h
        - sum_tmp = s1+s2+s3  # summe aus 1 - 3
        %td.border= sum_tmp
        - summe += sum_tmp
        - h = u.todo_hours(@date)
        %td.border= h
        - todoo += h    
        - sum_tmp = sum_tmp - h
        %td.border= sum_tmp
        - saldoo += sum_tmp

    %tr
      %td.bold TOTAL
      %td.bold= intern
      %td.bold= extern
      %td.bold= absence
      %td.bold= summe
      %td.bold= todoo
      %td.bold= saldoo

